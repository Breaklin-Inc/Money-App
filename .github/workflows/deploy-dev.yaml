name: Deploy to Dev

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: ${{github.actor}}

jobs:
  version:
    name: Set version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Login to Github Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: $USERNAME
          password: ${{secrets.GITHUB_TOKEN}}
      - name: Build image
        run: |
          docker build . --tag ghcr.io/$USERNAME/store:latest docker push ghcr.io/$USERNAME/store:latest

      - name: Set up SSH
        env:
          PRIVATE_KEY: ${{secrets.EC2_SSH}}
        run:  |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
      - name: SSH and deploy
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{secrets.EC2_HOST}} << 'EOF'
            echo "${{secrets.GITHUB_TOKEN}}" | docker login ghcr.io --u ${{github.actor}} --password-stdin
            docker pull ghcr.io/${{github.actor}}/store:latest
            docker stop store || true
            docker rm store || true
            docker run -d --name store --p 80:3002 ghcr.io/${{github.actor}}/store:latest
          EOF